# λΉ„κ΄€μ  vs. λ‚™κ΄€μ  λ™μ‹μ„± μ μ–΄
- μ¤λΌν΄μ€ μ™„λ²½ν• λ¬Έμ¥μμ¤€μ μ½κΈ° μΌκ΄€μ„±μ€ λ³΄μ¥ν•λ‚ νΈλμ­μ…μ— λ€ν•΄μ„λ” κΈ°λ³Έμ μΌλ΅ λ³΄μ¥ν•μ§€ μ•λ”λ‹¤.
## 1. λΉ„κ΄€μ  λ™μ‹μ„± μ μ–΄
- μ‚¬μ©μλ“¤μ΄ κ°™μ€ λ°μ΄ν„°λ¥Ό λ™μ‹μ— μμ •ν•  κ²ƒμ„ μ—Όλ‘μ— λ‘λ©° λ™μ‹μ„±μ΄ μ €ν•΄λ  κ²ƒμ΄λΌ κ°€μ •ν•κ³  νΈλμ­μ…μ„ μ μ–΄ν•λ‹¤.
- ν• μ‚¬μ©μκ°€ λ°μ΄ν„°λ¥Ό μ½λ” μ‹μ μ— Lockμ„ κ±Έκ³  μ΅°ν/κ°±μ‹ μ΄ μ™„λ£λ  λ•κΉμ§€ μ μ§€ν•λ‹¤.
### [μμ‹ 1]
- μ°μκ³ κ° λ€μƒμΌλ΅ μ λ¦½ν¬μΈνΈλ¥Ό μ¶”κ°€ν•λ‹¤κ³  κ°€μ •ν•  λ• λ‹¤μ–‘ν• μ‹¤μ μ •λ³΄, μ‚°μ¶κ³µμ‹μ— μν• μ λ¦½ν¬μΈνΈ κ³„μ‚°μ¤‘ λ‹¤λ¥Έ νΈλμ­μ…μ΄ κ³ κ° λ μ½”λ“ λ³€κ²½μ„ μ‹λ„ν•λ‹¤λ©΄ select for updateλ¬Έμ„ μ‚¬μ©ν•μ—¬ Lockμ„ κ±Έμ–΄ λ°μ΄ν„°κ°€ μλ» κ°±μ‹ λλ” λ¬Έμ λ¥Ό λ°©μ§€ν•λ‹¤.
```sql
-- select for updateλ¬Έμ„ μ‚¬μ©
select μ λ¦½ν¬μΈνΈ, λ°©λ¬Ένμ, μµκ·Όλ°©λ¬ΈμΌμ‹, κµ¬λ§¤μ‹¤μ  from κ³ κ° where κ³ κ°λ²νΈ = :cust_num for update nowait ;
-- μƒλ΅μ΄ μ λ¦½ν¬μΈνΈ κ³„μ‚°
update κ³ κ° set μ λ¦½ν¬μΈνΈ = :μ λ¦½ν¬μΈνΈ where κ³ κ°λ²νΈ = :cust_num;
```
### wait λλ” nowait μµμ…
- λ‘ μµμ… λ¨λ‘ λ™μ‹μ„± μ €ν•΄λ¥Ό λ°©μ§€ν•λ‹¤.
  - κ°€λ” SQLP κ°κ΄€μ‹μ—μ„ 'wait μµμ…μ€ λ™μ‹μ„±μ„ μ €ν•΄ν•λ‹¤.'λΌλ” μ–΄κ°μΌλ΅ ν—·κ°λ¦¬κ² μ„ μ§€λ¥Ό λ‚΄κ³¤ ν•λ”λ°.. λ‹¨μν 'wait'μ΄λΌκ³ ν•΄μ„ λ¬΄μ΅°κ±΄ λ™μ‹μ„±μ΄ μ €ν•λλ” κ±΄ μ•„λ‹μ„ μ§κ³  λ„μ–΄κ°€μ•Όν•λ‹¤.
  - μ¦‰, λ‘ μµμ… λ¨λ‘ λ™μ‹μ„± μ €ν•΄λ¥Ό λ°©μ§€ν•λ‹¤.(λ‘ μµμ… λ¨λ‘ λ™μ‹μ„± μ €ν•΄μ— μ μµν•λ‹¤λ” λ§μ”€ π)
- for update nowait μµμ…
  - λ€κΈ°μ—†μ΄ Exception(ORA-00054)μ„ λμ§„λ‹¤.
  - for update wait 3 : 3μ΄ λ€κΈ° ν›„ Exception(ORA-30006)μ„ λμ§„λ‹¤.
## 2. λ‚™κ΄€μ  λ™μ‹μ„± μ μ–΄
- μ‚¬μ©μλ“¤μ΄ κ°™μ€ λ°μ΄ν„°λ¥Ό λ™μ‹μ— μμ •ν•μ§€ μ•μ„ κ²ƒμ΄λΌ κ°€μ •ν•κ³  λ°μ΄ν„°λ¥Ό μ½μ„λ• Lockμ„ μ„¤μ •ν•μ§€ μ•μ€ μ±„ νΈλμ­μ…μ„ μ μ–΄ν•λ‹¤.
- β­οΈ λ°μ΄ν„° μμ • μ‹μ μ— μ•μ„ μ½μ€ λ°μ΄ν„°μ λ³€κ²½μ—¬λ¶€ λ°λ“μ‹ μ²΄ν¬ν•΄μ•Όν•λ‹¤.
- Lockμ΄ μ μ§€λλ” μ‹κ°„μ΄ λ§¤μ° μ§§μ•„μ Έ λ™μ‹μ„±μ„ λ†’μ΄λ”λ° μ λ¦¬ν•λ‹¤.
- ν•μ§€λ§ 'λ™μ‹μ„± μ μ–΄ μ—†λ” λ‚™κ΄€μ  ν”„λ΅κ·Έλλ°'μ΄ μ°λ ¤λλ‹¤.
### [μμ‹ 1]
- λ‹¤μμ€ μ¨λΌμΈ μ‡Όν•‘λ° μ£Όλ¬Έμ²λ¦¬ μ¤‘ μ½μ€ λ°μ΄ν„° μ»¬λΌ μ „μ²΄λ¥Ό where μ΅°κ±΄μΌλ΅ update κµ¬ν„ν•λ” νΈλμ­μ… κµ¬ν„ μ‚¬λ΅€μ΄λ‹¤.
```sql
insert into μ£Όλ¬Έ
select :μƒν’μ½”λ“, :κ³ κ°ID, :μ£Όλ¬ΈμΌμ‹, :μƒμ λ²νΈ, ...
from μƒν’
where μƒν’μ½”λ“ = :μƒν’μ½”λ“
and κ°€κ²© = :κ°€κ²© ; -- μ£Όλ¬Έμ„ μ‹μ‘ν• μ‹μ  κ°€κ²©

if sql%rowcount = 0 then alert('μƒν’κ°€κ²©μ΄ λ³€κ²½λμ—μµλ‹λ‹¤.');
end if;
```
### [μμ‹ 2]
```sql
select μ λ¦½ν¬μΈνΈ, λ°©λ¬Ένμ, μµκ·Όλ°©λ¬ΈμΌμ‹, κµ¬λ§¤μ‹¤μ  into :a, :b, :c, :d
from κ³ κ° where κ³ κ°λ²νΈ = :cust_num;

-- μƒλ΅μ΄ μ λ¦½ν¬μΈνΈ κ³„μ‚°
update κ³ κ°
set μ λ¦½ν¬μΈνΈ = :μ λ¦½ν¬μΈνΈ
where κ³ κ°λ²νΈ = :cust_num
and μ λ¦½ν¬μΈνΈ = :a
and λ°©λ¬Ένμ = :b
and μµκ·Όλ°©λ¬ΈμΌμ‹ = :c
and κµ¬λ§¤μ‹¤μ  = :d ;

if sql%rowcount = 0 then alert('λ‹¤λ¥Έ μ‚¬μ©μμ— μν•΄ λ³€κ²½λμ—μµλ‹λ‹¤.');
end if;
```
- λ‹¤μμ€ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•κΈ° μ§μ „μ— λ°μ΄ν„°μ λ³€κ²½μ—¬λ¶€λ¥Ό λ”°μ§€κ³ μ κ³ κ°λ²νΈλ¥Ό μ μ™Έν• 4κ°μ μ»¬λΌμ„ μ°Έμ΅°ν•μ—¬ 4κ°μ μ»¬λΌμ„ μ½μ€ μΏΌλ¦¬μ΄λ‹¤.ν•μ§€λ§ selectλ¬Έμ—μ„ μ½μ€ μ»¬λΌλ“¤μ΄ λ§μ€ κ²½μ° updateλ¬Έμ— μ΅°κ±΄μ μ„ μΌμΌμ΄ κΈ°μ ν•λ” λ²κ±°λ΅μ›€μ΄ μƒκΈ΄λ‹¤.
### [μμ‹ 3] μµμΆ… λ³€κ²½μΌμ‹λ΅ λΉ„κµν•κΈ°
- update λ€μƒ ν…μ΄λΈ”μ— μµμΆ…λ³€κ²½μΌμ‹λ¥Ό κ΄€λ¦¬ν•μ—¬ μ΅°κ±΄μ μ— μ‚¬μ©μ‹ κ°„λ‹¨ν•κ² λ μ½”λ“ κ°±μ‹ μ—¬λ¶€ ν™•μΈν•λ” λ°©λ²•μ΄ μλ‹¤.
-for update μ‚¬μ©μΌλ΅ λ™μ‹μ„±μ΄ μ €ν•λλ” κ²ƒμ„ μλ°©ν•λ‹¤.
```sql
-- μƒλ΅μ΄ μ λ¦½ν¬μΈνΈ κ³„μ‚°
select κ³ κ°λ²νΈ
from κ³ κ°
where κ³ κ°λ²νΈ = :cust_num
and λ³€κ²½μΌμ‹ = :mod_dt
for update nowait ; -- λ‹¤λ¥Έ νΈλμ μ…μ— μν•΄ μ„¤μ •λ Lock λ•λ¬Έμ— λ™μ‹μ„±μ΄ μ €ν•λλ” κ²ƒμ„ μλ°©ν•λ‹¤.

-- μµμΆ… λ³€κ²½μΌμ‹κ°€ μ•μ„ μ½μ€ κ°’κ³Ό κ°™μ€μ§€ λΉ„κµ
update κ³ κ° set μ λ¦½ν¬μΈνΈ = :μ λ¦½ν¬μΈνΈ, λ³€κ²½μΌμ‹ = SYSDATE
where κ³ κ°λ²νΈ = :cust_num
and λ³€κ²½μΌμ‹ = :mod_dt ; 
```
### [μμ‹ 4] ora_rowscnμ„ ν™μ©
- μ¤λΌν΄ 10gλ¶€ν„° μ κ³µν•λ” Pseudo μ»¬λΌ ora_rowscnμ„ ν™μ©ν•λ‹¤.
- Timestampλ¥Ό μ¤λΌν΄μ΄ μ§μ ‘ κ΄€λ¦¬ν•΄ μ£Όλ―€λ΅ μ‰½κ³  μ™„λ²½ν•κ² λ™μ‹μ„± μ μ–΄κ°€ κ°€λ¥ν•λ‹¤.
- ora_rowscn μ΄λΌλ” Pseudo μ»¬λΌμ„ μ΄μ©ν•λ©΄ νΉμ • λ μ½”λ“κ°€ λ³€κ²½λ ν›„ μ»¤λ°‹λ μ‹μ μ„ μ¶”μ ν•  μ μλ‹¤.
- λ”°λ΅ λ³€κ²½μΌμ‹ μ»¬λΌμ„ λ§λ“¤μ§€ μ•κ³ λ„ λ™μ‹μ„± μ μ–΄κ°€ κ°€λ¥ ν•λ‹¤.
```sql
 select μ λ¦½ν¬μΈνΈ, λ°©λ¬Ένμ, μµκ·Όλ°©λ¬ΈμΌμ‹, κµ¬λ§¤μ‹¤μ , ora_rowscn into :a, :b, :c, :d, :rowscn
from κ³ κ°
where κ³ κ°λ²νΈ = :cust_num;

-- μƒλ΅μ΄ μ λ¦½ν¬μΈνΈ κ³„μ‚°
update κ³ κ°
set μ λ¦½ν¬μΈνΈ = :μ λ¦½ν¬μΈνΈ, λ³€κ²½μΌμ‹ = SYSDATE
where κ³ κ°λ²νΈ = :cust_num
and ora_rowscn = :rowscn ;

if sql%rowcount = 0 then alert('λ‹¤λ¥Έ μ‚¬μ©μμ— μν•΄ λ³€κ²½λμ—μµλ‹λ‹¤.');
end if;end if;
```
- ora_rowscnμ„ μ‚¬μ©ν•κΈ° μ„ν•΄μ„ ν…μ΄λΈ” μƒμ„±μ‹ ROWDEPENDENCIES μµμ…μ„ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.
```sql
create table t
ROWDEPENDENCIES
nologging
as
select * from scott.emp;
```
- κΈ°λ³Έκ°’μ€ NOROWDEPENDENCIESμΈλ°, μ΄λ•λ” λΈ”λ΅λ‹¨μ„λ΅ ora_rowscnμ΄ λ³€κ²½λλ‹¤. 
### ora_rowscnμ„ ν™μ©μ‹ μ£Όμν•  μ 
- ora_rowscnμ΄ λ³€κ²½μΌμ‹ μ»¬λΌμ„ λ€μ²΄ν•  μλ” μ—†λ‹¤.μ¦‰ λ™μ‹μ„± μ μ–΄ μ©λ„λ΅λ§ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.
- ora_rowscnμ€ μκµ¬ν μ €μ¥λλ” κ°’μ΄μ§€λ§ μ΄λ¥Ό μ‹κ°„μ •λ³΄λ΅ λ³€ν™ν•λ” λ° μ‚¬μ©λλ” λ§¤ν•‘μ •λ³΄ ν…μ΄λΈ”(sys.smon_scn_time)μ λ³΄κ΄€μ£ΌκΈ°λ” 5μΌμ΄λ―€λ΅ 5μΌ λ„κ² μ§€λ‚ ora_rowscn μ •λ³΄μ Timestamp κ°’ (SCN_TO_TIMESTAMP(ORA_ROWSCN))μ„ κµ¬ν•λ ¤ ν•λ©΄ μ—λ¬(ORA-08181)κ°€ λ°μƒν•λ‹¤.
- μ΄λ” μ¦‰ scn_to_timestamp(ora_rowscn) μΌλ΅ λ³€κ²½ ν›„ μ»¤λ°‹λ μ‹μ μ„ μ¶”μ ν•  μλ„ μλ‹¤λ” λ§μ΄λ‹¤.