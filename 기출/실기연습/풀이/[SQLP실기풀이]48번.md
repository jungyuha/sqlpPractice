[SQLP실기문제]48번
문제 출처 : SQLP 자격검정 핵심노트1 P.163
문제 링크 : https://velog.io/@yooha9621/SQLP실기문제48번
**🍎 부분은 내가 생각했을때 튜닝하면서 봐야할 핵심부분을 체크한 곳이다.**

## 1) 데이터 정리
### 1.주문 상품 테이블
- 🍎월 단위 파티션🍎 테이블
- 한 달 주문상품 = 100만건
- 주문상품 총 건수 = 총 1억 2천만 건 (=100만 X 120개월)
- 할인유형코드 조건을 만족하는 데이터 비중 = 🍎20%🍎
### 2.상품 테이블
- 등록된 상품 = 2만개
- 🍎대부분 상품을 한달에 한 개 이상 주문🍎

## 2) 기존 쿼리 분석
**1. 주문상품 해당 월 파티션 액세스**
**2. 주문상품_X1 로컬 파티션 인덱스 스캔**
- 한 달 동안 주문된 100만건 : '주문일시' **액세스**
- 할인 유형 코드가 'k890'인 : '할인유형코드' **스캔**
   - 100만건중 **20%**  즉 , 20만건
   
**3. 2단계의 20만건을 상품 테이블과 NL조인**
- 🍎NL조인이 일어나는 횟수 : 20만건🍎

**4. 3단계의 20만건을 grouping**
- 대부분 상품을 한달에 한 개 이상 주문했으므로 그룹핑하면 약 2만건 추출

**5. 4단계의 2만건 Sort**

## 3) 🍎쿼리 튜닝🍎
### 1.주문 상품 테이블 액세스
- **100만건의 파티션 테이블에서 20만건을 뽑아내므로 _Full Scan_을 유도한다.**
### 2.상품 테이블 액세스
- 등록된 상품 = 2만개이고 2만 개 상품을 고르게 주문하므로 상품 테이블의 약 대개의 데이터가 액세스될 것이다.
   - **따라서 상품 테이블을 Full 스캔할 수 있도록 유도한다.**
   - Full 스캔하면 따라오는 건 뭐다? **해시 조인**인 거시다~~!
### 3.주문상품 - 상품 테이블 조인 방식
- ⭐️ 우선 20만건의 NL조인을 다른 방법의 조인으로 바꿔야한다. ⭐️
   - **주문 상품 테이블 따로 그룹핑을 하여 조인 대상 로우수를 2만건으로 줄인다.** 
   
## 4) 튜닝한 SQL문
   
```sql
SELECT /*+ LEADING(P) USE_HASH(O) FULL(P)*/
	P.상품코드 , P.상품명 , P.상품가격 , O.총주문수량 , O.총주문금액
FROM ( SELECT /*+ FULL(A) NO_MERGE*/ 상품코드 ,SUM(O.주문수량) 총주문수량 , SUM(O.주문금액) 총주문금액
  FROM 주문상품 A
  WHERE 주문일시 >= ADD_MONTHS(SYSDATE,-1)
  AND 할인유형코드 = 'K890'
  GROUP BY 상품코드 ) O , 상품 P
WHERE O.상품코드 = P.상품코드
ORDER BY 총 주문금액 DESC , 상품코드
```
> #### 😥 헷갈렸던 부분
- 🍎push_pred는 쓰지 않는다!
   - 왜냐하면 상품(P) 테이블을 먼저 리딩해서 해시맵에 깔아놓고 그 후에 그룹핑한 주문상품 2만건을 하나씩 해시조인 하는 방식으로 풀어냈기 때문이다.