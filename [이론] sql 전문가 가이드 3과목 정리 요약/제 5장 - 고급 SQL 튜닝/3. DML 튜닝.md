# 3. DML 튜닝

**기록 ✍️**

#### author : jung yuha

#### **first Registered : 2022-04-12**

#### last modified : **2023-04-30**

## \[1] 인덱스 유지 비용

### (1) 테이블 데이터 변경시

**변경할 인덱스 레코드를 찾아가는 비용 + Redo, Undo를 생성하는 비용이 발생한다.**

#### 1. Update 수행시

* 테이블 레코드는 직접 변경하지만 인덱스 레코드는 정렬 상태를 유지하기 위해 Delete & Insert 방식으로 처리한다.
* Undo 레코드도 2개씩 기록된다.
  * 따라서 변경 컬럼과 관련된 인덱스 개수에 따라 Update 성능이 좌우된다.

#### 2. Insert나 Delete 문일 때

* 인덱스 모두에 변경을 가하므로 총 인덱스 개수에 따라 성능이 크게 달라진다.

#### 3. 대량의 데이터를 입력/수정/삭제할 때

* 인덱스 개수가 DML 성능에 큰 영향을 미치므로 인덱스를 모두 Drop하거나 Unusable 상태로 변경한 다음 작업하는 것이 빠를 수 있다.

## \[2] Insert 튜닝

### (1) Oracle Insert 튜닝

#### 1. 일반적인 힙 구조 테이블에서의 데이터 입력 방법

* 데이터 입력시 빈 공간을 가진 블록리스트를 관리하는 Freelist로 부터 순서 없이 블록을 할당받아 무작위로 값을 입력하는 방식
* 대량의 데이터 입력시 이 방식은 비효율적이다.
* 일반적인 트랜잭션을 처리할 때는 빈 공간부터 찾아 채워 나가는 이 방식이 효율적

**Freelist**

* HWM(High-Water Mark) 아래쪽에 위치한 블록 중 어느 정도(테이블에 지정한 pctfree와 pctused 파라미터에 의해 결정됨) 빈 공간을 가진 블록 리스트를 관리하는 자료구조
* Freelist에서 할당받은 블록을 버퍼 캐시에서 찾아보고, 없으면 데이터 파일에서 읽어 캐시에 적재한 후에 데이터를 삽입한다.
* 대량의 데이터 입력시 이 방식은 비효율적이다.
  * 빈 블록은 얼마 지나지 않아 모두 채워지고 이후부터는 순차적으로 뒤쪽에만 데이터를 쌓게 될 텐데도 건건이 Freelist를 조회하면서 입력하기 때문이다.

#### 2. Direct Path Insert

**Freelist를 거치지 않고 HWM 바깥 영역에, 그것도 버퍼 캐시를 거치지 않고 데이터 파일에 곧바로 입력하는 방식이다.**

* 대량의 데이터 입력시 효율적
* Undo 데이터를 쌓지 않는 점도 속도 향상의 주요인이다.

**1) Oracle 에서 Direct Path Insert 방식으로 데이터를 입력하는 방법**

* insert select 문장에 `/*+ append */` 힌트 사용
* 병렬 모드로 insert
* direct 옵션을 지정하고 SQL\*Loader(sqlldr)로 데이터를 로드
* CTAS(create table … as select) 문장을 수행

**2) Direct Path Insert 방식으로 데이터 입력시 주의할 점**

* Exclusive 모드 테이블 Lock이 걸린다.
  * 작업이 수행되는 동안 해당 테이블에 DML 수행 불가.
* 따라서 트랜잭션이 빈번한 주간에 이 옵션을 사용하는 것은 절대 금물
* nologging 상태에서 입력한 데이터는 장애 발생시 복구 불가하다.

**3) nologging 모드 Insert하기**

```sql
alter table t NOLOGGING;
```

* Redo 로그까지 최소화(데이터 딕셔너리 변경사항만 로깅)되므로 더 빠르게 insert한다.
* logging 상태에서 입력한 데이터는 장애가 발생했을 때 복구가 불가능하다.
* 이 옵션을 사용해 데이터를 insert한 후에는 곧바로 백업을 실시해야 한다.
* 또는 언제든 재생 가능한 데이터를 insert할 때만 사용한다.
* 예를 들어 배치 프로그램에서 중간 단계의 임시 테이블을 만들 때가 대표적! DW 시스템에 읽기 전용 데이터를 적재할 때도 유용!
  * DW성 데이터는 OLTP로부터 언제든 재현해 낼 수 있기 때문이다.

## \[3] Update 튜닝
