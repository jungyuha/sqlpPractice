문제 링크 : https://velog.io/@yooha9621/SQLP실기문제-소트튜닝13번

## 1) 데이터 정리
### 1.상품 테이블
- 상품 총 건수 = 총 100개

### 2.주문 테이블
- 1달 주문건수 = 100만건
- 12달 주문건수 = 1200만건(총건수 대비 약 10% 넘음)
- 총 건수 = 총 1억 건 (=100만 X 100개월)
- 거의 모든 상품에 골고루 주문 발생

### 3.주문상품 테이블
- 총 건수 = 총 2억 건
- ⭐️ 1개의 상품코드당 약 200만개
- 1개의 주문당 약 2개의 주문상품

## 2) 기존 쿼리 분석
**1. 주문_X1(주문일자) 인덱스 통해 한달치 주문 액세스(100만건)**
**2. 1단계의 100만건을 주문상품_PK(주문번호 + 상품코드) 인덱스 통해 NL 조인**
   - 거의 모든 상품에 골고루 주문이 발생하므로 상품코드 조건에 걸러지는 데이터가 거의 없을듯
   
**3. 2단계의 약 200만건 중복 제거 Sort**
### ⭐️ 답안 튜닝 포인트 
1. 주문 상품에 NL_SJ 조인을 하거나 EXISTS문을 통해 접근하면 최소 100만건 이상을 수행해야하므로 옳지 않다.따라서 해시 조인으로 실행하도록한다.
1. 먼저 스캔할 테이블을 정한다.(해시 맵 Build Input)
   - 상품코드 '=' 조건을 만족하는 주문상품 테이블의 데이터는 약 200만건이다.
   - 이 200만건을 인덱스(상품코드)로 조회하여 해시 맵 Build Input으로 둔 뒤 '주문'테이블에서 '주문번호'로 해시 조인을 시도하는데 이 때 ⭐️ 주문상품_PK : 주문번호 + 상품코드 ⭐️ 이므로 겹치는 데이터가 없어 DISTINCT도 없앨 수 있다.


## 3) 쿼리 튜닝
### 1.주문 상품 테이블 액세스
- 주문 상품 테이블을 상품유형코드 '=' 조건으로 조회하도록 주문상품_X1 인덱스를 사용한다.
   - **주문상품_X1 : 상품코드** 인덱스 추가
- 주문 상품 테이블을 해시맵 Build Input으로 둔다.
   
### 2.주문 테이블 액세스
- 주문 테이블 총 건수 대비 10% 이상의 데이터를 스캔하므로 TABLE FULL SCAN으로 진행한다.
   
### 2.주문 테이블과 주문상품 테이블 해시 조인 
## 2) 튜닝한 SQL문
   
```sql
[인덱스 추가]
주문상품_X1 : 상품코드

SQL > SELECT /*+LEADING(P) INDEX(P 주문상품_X1) FULL(O) USE_HASH(O)*/
0. 주문번호, 0.주문금액, 0.결제구분코드, 0.주문매체코드
FROM 주문 0, 주문상품 P
WHERE 0.주문일자 >= TRUNC(ADD_MONTHS(SYSDATE, -12))
AND P.주문번호 = 0.주문번호
AND P.상품코드 = :PRD_CD
```

> #### 🍎 정리
- 주문 상품 테이블을 드라이빙 테이블로 두어 상품 코드 조건을 만족하는 약 200만건을 추출해 해시맵 Build Input으로 둔다.
- 주문 상품 테이블의 PK는 주문번호+상품코드 이므로 주문 테이블과 '주문 번호'로 해시 조인할시 겹치는 데이터가 없으므로 중복 소트인 DISTINCT 문을 삭제한다.
- 주문 테이블 조회는 FULL 스캔으로 수행한다.


> #### ✅ 조심할 부분
- 해시 조인을 쓰는 목적을 제대로 알고 쓸 줄 알아야한다.
- ⭐️ 즉 , NL조인을 하기엔 액세스 량이 너무 많은 경우 !! 그 대안으로 해시 조인을 쓰도록 하자!!
   

   