# 1. 소트튜닝 - 13번

**기록 ✍️**

#### author : jung yuha

#### **first Registered : 2022-07-02**

#### last modified : **2022-07-02**

## \[1] 문제

문제 출처 : SQLP 자격검정 핵심노트2 P.24

아래 SQL 튜닝하시오.\
필요시 인덱스 재구성안을 제시하시오.\
원하는 실행계획이 나오도록 힌트를 정확히 기술하시오.

### \[데이터] <a href="#undefined" id="undefined"></a>

상품 : 100개\
주문 : 1억 건\
주문상품 : 2억 건\
▶ 한달 주문건수 = 100만 건\
▶ 거의 모든 상품에 골고루 주문 발생

### \[인덱스 구성] <a href="#undefined" id="undefined"></a>

주문\_PK : 주문번호\
주문\_X1 : 주문일자\
주문상품\_PK : 주문번호 + 상품코드

### \[쿼리] <a href="#undefined" id="undefined"></a>

```sql
SQL > SELECT DISTINCT 0. 주문번호, 0.주문금액, 0.결제구분코드, 0.주문매체코드
FROM 주문 0, 주문상품 P
WHERE 0.주문일자 >= TRUNC(ADD_MONTHS(SYSDATE, -12))
AND P.주문번호 = 0.주문번호
AND P.상품코드 = :PRD_CD

Execution Plan
------------------------------------------------------------------------------ 
|  0| SELECT STATEMENT Optimizer=ALL_ROWS (Cost=3 Card=1 Bytes=80)
|  1|  HASH(UNIQUE) (Cost=3 Card=1 Bytes=80)
|  2|   FILTER
|  3|    NESTED LOOPS
|  4|     NESTED LOOPS (Cost=2 Card=1 Bytes=80)
|  5|     	TABLE ACCESS (BY INDEX ROWID) OF '주문' (TABLE) (Cost=1 … )
|  6|      		INDEX (RANGE SCAN) OF '주문_X1' (INDEX) (Cost=1 Card=1)
|  7|       INDEX (RANGE SCAN) OF '주문상품_X2' (INDEX) (Cost=1 Card=1)
------------------------------------------------------------------------------
```

## \[2] 풀이

### 1) 데이터 정리 <a href="#1" id="1"></a>

#### 1.상품 테이블 <a href="#1" id="1"></a>

* 상품 총 건수 = 총 100개

#### 2.주문 테이블 <a href="#2" id="2"></a>

* 1달 주문건수 = 100만건
* 12달 주문건수 = 1200만건(총건수 대비 약 10% 넘음)
* 총 건수 = 총 1억 건 (=100만 X 100개월)
* 거의 모든 상품에 골고루 주문 발생

#### 3.주문상품 테이블 <a href="#3" id="3"></a>

* 총 건수 = 총 2억 건
* ⭐️ 1개의 상품코드당 약 200만개
* 1개의 주문당 약 2개의 주문상품

### 2) 기존 쿼리 분석 <a href="#2" id="2"></a>

**1. 주문\_X1(주문일자) 인덱스 통해 1년치 주문 액세스(1200만건)**\
**2. 1단계의 1200만건을 주문상품\_PK(주문번호 + 상품코드) 인덱스 통해 NL 조인**

* 거의 모든 상품에 골고루 주문이 발생하므로 상품코드 조건에 걸러지는 데이터가 거의 없을듯

**3. 2단계 결과집합 중복 제거 Sort**

#### ⭐️ 답안 튜닝 포인트 <a href="#undefined" id="undefined"></a>

1. 주문 상품에 NL\_SJ 조인을 하거나 EXISTS문을 통해 접근하면 최소 1200만건 이상을 수행해야하므로 옳지 않다.따라서 해시 조인으로 실행하도록한다.
2. 먼저 스캔할 테이블을 정한다.(해시 맵 Build Input)
   * 상품코드 '=' 조건을 만족하는 주문상품 테이블의 데이터는 약 200만건이다.
   * 주문 상품은 '상품코드'와 '주문일자'로만 검색하므로 주문상품\_PK를 Index fast full 스캔하여 build 인풋으로 놓는다.
3. 주문 테이블은 1억건중 1200만건이므로 풀스캔으로 처리한다.

### 3) 튜닝한 SQL문 <a href="#3-sql" id="3-sql"></a>

```sql
SELECT /*+ LEADING(P) INDEX_FFS(P 주문상품_PK) USE_HASH(O) FULL(O) */
0. 주문번호, 0.주문금액, 0.결제구분코드, 0.주문매체코드
FROM 주문 0, 주문상품 P
WHERE 0.주문일자 >= TRUNC(ADD_MONTHS(SYSDATE, -12))
AND P.주문번호 = 0.주문번호
AND P.상품코드 = :PRD_CD
```

> **✅ 조심할 부분**
>
> * 해시 조인을 쓰는 목적을 제대로 알고 쓸 줄 알아야한다.
> * ⭐️ 즉 , NL조인을 하기엔 액세스 량이 너무 많은 경우 !! 그 대안으로 해시 조인을 쓰도록 하자!!
> * 주문 테이블은 1억건중 1200만건이므로 풀스캔으로 처리한다.
