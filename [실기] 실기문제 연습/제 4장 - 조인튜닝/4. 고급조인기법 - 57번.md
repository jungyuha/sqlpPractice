# 4. 고급조인기법 - 57번

**기록 ✍️**

#### author : jung yuha

#### **first Registered : 2022-06-28**

#### last modified : **2022-06-28**

## \[1] 문제&#x20;

![](https://velog.velcdn.com/images/yooha9621/post/e9fd104a-f147-413f-b893-904ff3e7c3ba/image.png)

아래 데이터 모델에서 장비구분코드가 'A001'인 장비의 최종(=현재) 상태코드 , 변경일자 , 변경순번을 출력하는 최적 SQL을 작성하세요.

* 장비구분코드 ='A001'인 장비는 10건이다.
* 결과집합을 장비번호 순으로 정렬한다.
* 장비 테이블의 최종변경일시는 상태코드 변경과 무관하다.
* DBMS는 오라클이며 , 12c 이후 버전이다.

### \[1] 인덱스 구성 <a href="#1" id="1"></a>

* 장비\_PK : 장비번호
* 장비\_X1 : 장비구분코드
* 상태변경이력\_PK : 장비번호 + 변경일자 + 변경순번

## \[2] 풀이

### 1) 쿼리 튜닝 <a href="#1" id="1"></a>

#### 1. 장비 테이블 액세스 <a href="#1" id="1"></a>

* 조회조건 중 장비구분코드 = 'A001'이 적용될 수 있도록 선두컬럼이 장비구분코드인 장비\_X1 인덱스를 사용한다.
* 드라이빙 테이블로 들어간다.\


#### 2. 상태변경이력 테이블 액세스 <a href="#2" id="2"></a>

* 조회 조건으로 '장비번호'를 선두로 하고 상태변경이력\_PK 인덱스를 사용해 NL조인하여 변경일자 + 변경 순번의 가장 최근 1건을 뽑는다.
  * 이 때 정렬이 무너지지 않도록 처리해야한다.

### 2) 튜닝한 SQL문 <a href="#2-sql" id="2-sql"></a>

```sql
SELECT P.장비번호 , P.장비명 , A.상태코드 AS 최종상태코드
, A.변경일자 AS 최종변경일자 , A.변경순번 AS 최종변경순번
  FROM 장비 P , 상태변경이력 A
  WHERE P.장비구분코드 = 'A001'
  AND A.장비번호 = P.장비번호
  AND (P.변경일자 , P.변경순번) = (
	  SELECT 변경일자 , 변경순번
      FROM (
        SELECT 변경일자 , 변경순번
        FROM 상태변경이력 
        WHERE 장비번호 = A.장비번호
        ORDER BY 변경일자 DESC , 변경순번 DESC
        )
     WHERE ROWNUM <=1 )
ORDER BY P.장비번호;
```

> **🍎 정리**
>
> * 장비구분코드가 'A0001' 인 장비 데이터를 드라이빙 테이블로 놓고 장비번호로 상태변경이력 테이블과 조인하는데 조인하는 데이터의 변경일자와 변경순번이 가장 최근인 1건만 가지고 오기 위해 다중컬럼 비교절을 통해 다시 상태변경이력을 조회하도록 한다.
