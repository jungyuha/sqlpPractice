# 4. 고급조인기법 - 60번

**기록 ✍️**

#### author : jung yuha

#### **first Registered : 2022-06-30**

#### last modified : **2022-06-30**

## \[1] 문제

![](https://velog.velcdn.com/images/yooha9621/post/a7e41e58-b441-4f41-8c29-94328094d548/image.png)

문제 출처 : SQLP 자격검정 핵심노트1 P.175

아래 데이터 모델에서 장비구분코드가 'A001'인 장비의 최종상태코드와 직전(=상태변경이력의 유효시작일자가 장비의 최종상태변경일시보다 작은) 상태변경이력의 상태코드와 변경일자를 출력하는 최적 SQL을 작성하세요.

* 장비구분코드 ='A001'인 장비는 10건이다.
* 결과집합을 장비번호 순으로 정렬한다.
* 장비 테이블의 최종상태변경일시는 상태코드를 가장 마지막으로 변경한 일시이다.
* 상태변경이력은 선분이력 테이블이다.
* 장비 테이블의 최종상태변경일시와 상태변경이력의 유효시작일시,유효종료일시는 DATE형이다.

### \[1] 인덱스 구성 <a href="#1" id="1"></a>

* 장비\_PK : 장비번호
* 장비\_X1 : 장비구분코드
* 상태변경이력\_PK : 장비번호 + 유효종료일시 + 유효시작일시

## \[2] 풀이

### 1) 쿼리 튜닝 <a href="#1" id="1"></a>

#### 1. 장비 테이블 액세스 <a href="#1" id="1"></a>

* 조회조건 중 장비구분코드 = 'A001'이 적용될 수 있도록 선두컬럼이 장비구분코드인 장비\_X1 인덱스를 사용한다.
* 드라이빙 테이블로 들어간다.\


#### 2. 상태변경이력 테이블 액세스 <a href="#2" id="2"></a>

* 조회 조건으로 '장비번호'를 선두로 하고 상태변경이력\_PK 인덱스를 사용해 장비 테이블의 최종상태변경일시보다 작은 유효종료일자를 가진 가장 최근 데이터를 찾아 NL조인한다.

### 2) 튜닝한 SQL문 <a href="#2-sql" id="2-sql"></a>

```sql
SELECT P.장비번호 , P.장비명 , P.최종상태코드 , H.상태코드 AS 직전상태코드
, TO_CHAR(P.최종상태변경일시,'YYYYMMDD') AS 최종상태변경일자
, TO_CHAR(H.유효시작일시,'YYYYMMDD') AS 직전변경일자
FROM 장비 P , 상태변경이력 H
WHERE P.장비구분코드 = 'A001'
AND H.장비번호 = P.장비번호
AND H.유효시작일시 < P.최종상태변경일시
AND H.유효종료일시 >= P.최종상태변경일시 - 1/(60*60*24) --최종상태변경일시 1초전 보다는 크다.
ORDER BY P.장비번호
```

> **🍎 정리**
>
> * 장비구분코드가 'A0001' 인 장비 데이터를 드라이빙 테이블로 놓고 장비번호로 상태변경이력 테이블과 조인하는데 조인하는 데이터의 유효시작일시가 최종 상태 변경일시**'보다'** 작으면서 유효종료일자가 가장 최근인 데이터를 NL조인한다.
>   * 이 때 유효종료일자가 가장 최근인 데이터를 구하기 위해\
>     **H.유효종료일시 >= P.최종상태변경일시 - 1/(60**_**60**_**24)** 조건절을 사용했다.

> **🍎 헷갈렸던 점**
>
> * 해당 쿼리를 두번째 쿼리로 바꿀 수 있어야 했다.
>
> ```sql
> SELECT *
> FROM (SELECT 상태코드 , 유효종료일시
> FROM 상태변경이력
> AND 장비번호 = P.장비번호
> AND P.최종상태변경일자 > 유효종료일자
> ORDER BY 유효종료일자 DESC )
> WHERE ROWNUM <= 1
> ```
>
> * 이 쿼리로 !!
>
> ```sql
> SELECT 상태코드 , 유효종료일시
> FROM 상태변경이력
> AND 장비번호 = P.장비번호
> AND 유효시작일시 < P.최종상태변경일시
> AND 유효종료일시 >=  P.최종상태변경일시 - 1/(60*60*24) --최종상태변경일시 1분전보다는 크다.
> ```
